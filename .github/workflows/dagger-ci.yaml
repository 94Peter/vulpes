name: Dagger-CI

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  issues: write

jobs:
  dagger-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. å•Ÿå‹• Dagger (é€™æœƒè‡ªå‹•è™•ç† Dagger Engine çš„å•Ÿå‹•)
      - name: Run Dagger CI
        uses: dagger/dagger-for-github@v7
        with:
          # å‘¼å«ä½ åœ¨ dagger/main.go å®šç¾©çš„ Ci å‡½å¼
          verb: call
          args: ci --source=.
        env:
          # å¦‚æžœä½ çš„ Dagger éœ€è¦å­˜å– GitHub Secrets å¯ä»¥åœ¨æ­¤å‚³å…¥
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. ç¨ç«‹ä¸€å€‹ Job ä¾†è™•ç†å¤±æ•—æ™‚çš„ Issue å»ºç«‹
  create-issue-on-failure:
    needs: dagger-ci
    runs-on: ubuntu-latest
    # åƒ…åœ¨ Dagger CI å¤±æ•—ï¼Œä¸”ä¸æ˜¯åœ¨ç‰¹å®š fork å°ˆæ¡ˆæ™‚åŸ·è¡Œ
    if: failure() && github.repository_owner != 'arwoosa'
    steps:
      - name: Create Issue
        uses: dacbd/create-issue-action@main
        with:
          token: ${{ github.token }}
          title: |
            [${{ github.workflow }}] âŒ CI Failure on ${{ github.ref_name }}
          assignees: ${{ github.actor }}
          labels: CICD, bug
          body: |
            ## ðŸš¨ CI Failure Report
            
            Dagger pipeline åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒã€‚

            - **Run Details**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Commit**: ${{ github.sha }}
            - **Author**: @${{ github.triggering_actor }}

            ---
            > æ­¤ Issue ç”± GitHub Action è‡ªå‹•å»ºç«‹ï¼Œè«‹åœ¨ä¿®æ­£å¾Œé—œé–‰ã€‚